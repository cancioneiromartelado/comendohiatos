<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Escansão Poética — Protótipo</title>
  <style>
    :root {
      --bg:#0b0d12;
      --card:#121521;
      --muted:#8fa0b3;
      --text:#e6ecf3;
      --accent:#79b8ff;
      --ok:#3fb950;
      --warn:#d29922;
      --info:#58a6ff;
      --merge:#1f6feb;
      --del:#f85149;
    }
    *{box-sizing:border-box;}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;background:var(--bg);color:var(--text);}
    header{padding:20px;border-bottom:1px solid #1e2433;background:#0c1018;}
    h1{font-size:20px;margin:0;letter-spacing:0.2px;}
    main{max-width:1200px;margin:0 auto;padding:20px;}
    .card{background:var(--card);border:1px solid #20283a;border-radius:14px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.25);}
    .row{display:grid;grid-template-columns:1.2fr .8fr;gap:16px;}
    textarea,input[type="text"]{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #2a3347;background:#0e1320;color:var(--text);}
    textarea{resize:vertical;min-height:90px;}
    button{background:#101a2b;border:1px solid #2a3347;color:var(--text);padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:600;}
    button:hover{border-color:var(--accent);}
    .muted{color:var(--muted);font-size:13px;}
    .monosmall{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono",monospace;font-size:12px;}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid #2a3347;background:#0f1626;margin-right:6px;margin-bottom:6px;}
    .grid{display:grid;gap:12px;}
    .grid-2{grid-template-columns:repeat(2,minmax(0,1fr));}
    .section-title{font-weight:700;margin:14px 0 8px;letter-spacing:.2px;}
    code{background:#0e1320;border:1px solid #2a3347;padding:2px 6px;border-radius:6px;}
    .hint{border-left:3px solid #2a3347;padding-left:10px;margin:10px 0;}
    details{background:#0f1626;border:1px solid #2a3347;border-radius:12px;padding:10px 12px;}
    summary{cursor:pointer;font-weight:600;}
    table{width:100%;border-collapse:collapse;font-size:14px;}
    th,td{border-bottom:1px solid #1e2433;padding:8px;text-align:left;vertical-align:top;}
    .tag{border-radius:6px;padding:2px 6px;font-size:12px;border:1px solid #2a3347;}
    .tag.merge{background:rgba(31,111,235,.15);border-color:#1f6feb;}
    .tag.del{background:rgba(248,81,73,.15);border-color:#f85149;}
    .tag.info{background:rgba(88,166,255,.15);border-color:#58a6ff;}
    .kbd{border:1px solid #2a3347;background:#0e1320;border-radius:6px;padding:1px 6px;font-family:ui-monospace,monospace;font-size:12px;}
    .steps li{margin-bottom:6px;}
    s{color:var(--del);}
  </style>
</head>
<body>
  <header>
    <h1>Escansão Poética — Protótipo</h1>
  </header>
  <main>
    <div class="row">
      <section class="card">
        <label for="texto" class="section-title">Verso/frase</label>
        <textarea id="texto" placeholder="Ex.: Amor e ódio andavam lado a lado"></textarea>
        <div style="display:flex;gap:8px;margin-top:10px;align-items:center;flex-wrap:wrap;">
          <button id="analisar">Analisar</button>
          <button id="gerarVariacoes">Gerar variações</button>
          <span class="muted">O passo a passo abaixo evidencia sinérese (interna), elisão e sinalefa (entre palavras).</span>
        </div>
        <div class="hint muted" style="margin-top:10px;">
          <b>Sílabas gramaticais</b> dividem palavras independentemente; <b>sílabas poéticas</b> permitem fusões (<i>sinalefa</i>, <i>elisão</i>, <i>sinérese</i>) e a contagem vai <u>até a sílaba tônica da última palavra</u>.
        </div>
      </section>
      <aside class="card">
        <div class="section-title">Léxico de prosódia (opcional)</div>
        <div class="muted" style="margin-bottom:8px;">Cole JSON no formato: { "palavra": { "syllables": ["...","..."], "stress": 0_based } }.<br/>As chaves devem ser <b>minúsculas</b> (com acentos). Salvo em <span class="kbd">localStorage</span>.</div>
        <textarea id="lexiconText" placeholder='{"amor":{"syllables":["a","mor"],"stress":1}}'></textarea>
        <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap;">
          <button id="btnLoadLexicon">Carregar léxico</button>
          <button id="btnClearLexicon">Limpar léxico</button>
          <span id="lexiconStatus" class="muted">Nenhum léxico carregado.</span>
        </div>
        <div class="section-title" style="margin-top:16px;">Classificações alvo</div>
        <div class="grid grid-2">
          <div class="pill">5 — redondilha menor</div>
          <div class="pill">7 — redondilha maior</div>
          <div class="pill">10 — decassílabo</div>
          <div class="pill">12 — alexandrino</div>
        </div>
        <div class="muted" style="margin-top:8px;">Outras contagens → verso livre.</div>
      </aside>
    </div>

    <section class="card" style="margin-top:16px;">
      <div id="saidaOverview" class="muted">Nenhuma análise ainda.</div>
      <div id="passos"></div>
      <div id="variantes"></div>
      <div id="detalhes"></div>
    </section>

    <details style="margin-top:12px;">
      <summary>Metodologia (resumo técnico)</summary>
      <ul>
        <li><b>Léxico (opcional):</b> quando disponível, usa tônica e silabação do léxico para a <u>tônica da última palavra</u> e para exibir a silabação "padrão" (não obriga a segmentação do verso).</li>
        <li><b>Sílabas gramaticais:</b> segmentação correta com base em vogais e ditongos.</li>
        <li><b>Sinérese (interna):</b> fusão heurística de hiatos envolvendo <i>i/u</i> com vogal adjacente; gera variações.</li>
        <li><b>Entre palavras:</b> <i>elisão</i> (vogal átona final tachada) e <i>sinalefa</i> (fusão de vogal final + inicial, h- mudo permitido).</li>
        <li><b>Contagem poética:</b> total até a sílaba tônica da última palavra após fusões.</li>
      </ul>
    </details>
  </main>

  <script>
    let USER_LEXICON = {};
    const MINI_LEXICON = {
      "amor": { syllables:["a","mor"], stress:1 },
      "ódio": { syllables:["ó","dio"], stress:0 },
      "andavam": { syllables:["an","da","vam"], stress:1 },
      "lado": { syllables:["la","do"], stress:0 },
      "vida": { syllables:["vi","da"], stress:0 },
      "eterna": { syllables:["e","ter","na"], stress:1 }
    };

    function loadLexiconFromStorage(){
      try{ const raw = localStorage.getItem('pt_lexicon'); USER_LEXICON = raw ? JSON.parse(raw) : {}; }
      catch(e){ USER_LEXICON = {}; }
      updateLexiconStatus();
    }
    function saveLexiconToStorage(){ localStorage.setItem('pt_lexicon', JSON.stringify(USER_LEXICON)); updateLexiconStatus(); }
    function updateLexiconStatus(){
      const n = Object.keys(USER_LEXICON).length;
      document.getElementById('lexiconStatus').textContent = n>0 ? `${n} entradas carregadas.` : 'Nenhum léxico carregado.';
    }

    const V = "aeiouáéíóúâêôãõà";
    const ACENTUADAS = /[áéíóúâêôãõàÁÉÍÓÚÂÊÔÃÕÀ]/;
    const DITONGOS = ["ai","ei","oi","ui","au","eu","ou","ia","ie","io","iu","ua","ue","uo","ão","õe","ãi","uai","uau","uei","iau","iao","iei","uou"];

    function isVowel(ch){ return V.includes((ch||'').toLowerCase()); }

    function normalizeInput(s){
      return s.replace(/[\u2018\u2019\u201A\u201B]/g, "'")
              .replace(/[\u201C\u201D\u201E\u201F]/g, '"')
              .replace(/[^\p{L}\p{M}\s'’-]/gu, ' ')
              .replace(/[’’-]/g, '-')
              .replace(/\s+/g, ' ')
              .trim();
    }

    function tokenize(s){ return s.split(/\s+/).filter(Boolean); }

    // ========================= Silabificação Gramatical =========================
    function splitSyllablesGramatical(word){
      const w = word.toLowerCase();
      const vowels = "aeiouáéíóúâêôãõà";
      let syls = [];
      let current = "";
      for(let i=0;i<w.length;i++){
        current += word[i];
        if(vowels.includes(w[i].toLowerCase())){
          syls.push(current);
          current = "";
        }
      }
      if(current) syls.push(current);
      // Ajuste final de consoantes finais
      if(syls.length>=2 && ![...syls[syls.length-1]].some(c=>vowels.includes(c))) {
        syls[syls.length-2] += syls[syls.length-1];
        syls.pop();
      }
      return syls;
    }

    function splitSyllablesPoetica(word){
      // mesma função que antes, heurística poética
      const w = word.toLowerCase();
      const out = []; let syl = ''; let i = 0;
      while(i < w.length){
        const ch = w[i]; syl += word[i];
        if(isVowel(ch)){
          for(let span=3; span>=2; span--){
            const seg = w.slice(i, i+span);
            if(DITONGOS.includes(seg)){
              syl = syl.slice(0, syl.length-1) + word.slice(i, i+span);
              i += (span-1); break;
            }
          }
          out.push(syl); syl = '';
        }
        i++;
      }
      if(syl) out.push(syl);
      const fix = [];
      for(let j=0;j<out.length;j++){
        const s = out[j];
        if(![...s].some(isVowel)
